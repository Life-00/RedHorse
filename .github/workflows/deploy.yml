name: Deploy to AWS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  AWS_REGION: ap-northeast-2
  DOMAIN_NAME: your-app.com

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests
      run: npm test -- --coverage --watchAll=false
    
    - name: Build application
      run: npm run build
      env:
        REACT_APP_API_BASE_URL: https://api.${{ env.DOMAIN_NAME }}
        REACT_APP_ENVIRONMENT: production

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build application
      run: npm run build
      env:
        REACT_APP_API_BASE_URL: https://api.${{ env.DOMAIN_NAME }}
        REACT_APP_ENVIRONMENT: production
        REACT_APP_DEBUG_MODE: false
    
    - name: Deploy CloudFormation stack
      run: |
        aws cloudformation deploy \
          --template-file aws/cloudformation-frontend.yaml \
          --stack-name shifthealth-frontend \
          --parameter-overrides \
            DomainName=${{ env.DOMAIN_NAME }} \
            ApiGatewayDomain=api.${{ env.DOMAIN_NAME }} \
          --capabilities CAPABILITY_IAM \
          --region ${{ env.AWS_REGION }}
    
    - name: Get stack outputs
      id: stack-outputs
      run: |
        S3_BUCKET=$(aws cloudformation describe-stacks \
          --stack-name shifthealth-frontend \
          --query 'Stacks[0].Outputs[?OutputKey==`S3BucketName`].OutputValue' \
          --output text \
          --region ${{ env.AWS_REGION }})
        
        CLOUDFRONT_ID=$(aws cloudformation describe-stacks \
          --stack-name shifthealth-frontend \
          --query 'Stacks[0].Outputs[?OutputKey==`CloudFrontDistributionId`].OutputValue' \
          --output text \
          --region ${{ env.AWS_REGION }})
        
        echo "s3-bucket=$S3_BUCKET" >> $GITHUB_OUTPUT
        echo "cloudfront-id=$CLOUDFRONT_ID" >> $GITHUB_OUTPUT
    
    - name: Deploy to S3
      run: |
        aws s3 sync build/ s3://${{ steps.stack-outputs.outputs.s3-bucket }} \
          --delete \
          --region ${{ env.AWS_REGION }}
    
    - name: Invalidate CloudFront
      run: |
        aws cloudfront create-invalidation \
          --distribution-id ${{ steps.stack-outputs.outputs.cloudfront-id }} \
          --paths "/*" \
          --region ${{ env.AWS_REGION }}
    
    - name: Deployment summary
      run: |
        echo "ğŸš€ Deployment completed successfully!"
        echo "ğŸŒ Website: https://${{ env.DOMAIN_NAME }}"
        echo "ğŸ“¦ S3 Bucket: ${{ steps.stack-outputs.outputs.s3-bucket }}"
        echo "ğŸ”„ CloudFront: ${{ steps.stack-outputs.outputs.cloudfront-id }}"