---
inclusion: always
---

# 아키텍처 결정 기록 (ADR)

## ADR-001: AWS Cognito 선택

**결정**: 사용자 인증에 AWS Cognito User Pool 사용

**배경**:
- 서버리스 아키텍처와의 완벽한 통합
- JWT 토큰 기반 인증 지원
- 확장성과 보안성 보장
- 관리 오버헤드 최소화

**대안 고려**:
- Auth0: 비용이 높고 AWS 생태계 통합도가 낮음
- 자체 구현: 보안 위험과 개발 복잡도 증가
- Firebase Auth: AWS 생태계와 호환성 문제

**결과**:
- API Gateway Cognito Authorizer 사용
- JWT 토큰의 `sub` 클레임으로 사용자 식별
- 역할 기반 접근 제어 (RBAC) 구현

**상태**: 승인됨

---

## ADR-002: RDS PostgreSQL 선택

**결정**: 데이터베이스로 RDS PostgreSQL 사용 (DynamoDB 대신)

**배경**:
- 복잡한 관계형 데이터 모델 필요
- ACID 트랜잭션 보장 필요 (온보딩, 근무표 업데이트)
- 외래 키 제약 조건으로 데이터 무결성 보장
- 복잡한 쿼리 및 집계 연산 지원

**대안 고려**:
- DynamoDB: NoSQL이지만 관계형 데이터에 부적합, 복잡한 쿼리 제한
- RDS MySQL: PostgreSQL 대비 JSON 지원 및 고급 기능 부족
- Aurora Serverless: 콜드 스타트 문제와 비용 예측 어려움

**결과**:
- RDS Proxy를 통한 Lambda 연결 최적화
- 트랜잭션 기반 데이터 일관성 보장
- 복잡한 B2B 통계 쿼리 지원

**상태**: 승인됨

---

## ADR-003: 캐시 TTL 48시간 설정

**결정**: 엔진 계산 결과 캐시 TTL을 48시간으로 설정

**배경**:
- 오늘/내일 수면 권장사항만 유효하게 유지
- 근무표 변경 시 즉시 무효화 가능
- 배치 작업 실패 시에도 하루 여유 제공
- 스토리지 비용과 성능의 균형

**대안 고려**:
- 24시간: 배치 실패 시 캐시 부족 위험
- 72시간: 불필요한 스토리지 사용
- 무제한: 메모리 부족 및 일관성 문제

**결과**:
- `engine_cache` 테이블에 `expires_at` 컬럼 추가
- 매일 배치 작업으로 만료된 캐시 자동 정리
- 실시간 계산 fallback 메커니즘 구현

**상태**: 승인됨

---

## ADR-004: 커서 기반 페이지네이션 선택

**결정**: 근무표 조회에 커서 기반 페이지네이션 사용

**배경**:
- 오프셋 기반 페이지네이션의 성능 문제 해결
- 데이터 추가/삭제 시에도 일관된 결과 제공
- 대용량 데이터셋에서 안정적인 성능
- PostgreSQL의 복합 인덱스 활용

**대안 고려**:
- 오프셋 기반: OFFSET이 클수록 성능 저하
- 시간 기반: 동일 시간 데이터 처리 복잡
- 무제한 로딩: 메모리 부족 위험

**결과**:
- `(date, schedule_id)` 복합 커서 사용
- `nextCursor` 객체로 다음 페이지 정보 제공
- 최대 100개 항목 제한

**상태**: 승인됨

---

## ADR-005: EventBridge Scheduler 사용

**결정**: 배치 작업 스케줄링에 EventBridge Scheduler 사용

**배경**:
- 정확한 시간대 지원 (Asia/Seoul)
- CloudWatch Events보다 유연한 스케줄링
- Lambda 함수와 직접 통합
- 실패 시 재시도 로직 내장

**대안 고려**:
- CloudWatch Events: 시간대 지원 제한
- Step Functions: 단순 배치에는 과도한 복잡성
- 외부 크론 서비스: AWS 생태계 통합도 낮음

**결과**:
- 매일 새벽 3시 (KST) 캐시 갱신 실행
- 배치 실패 시 CloudWatch 알람 발송
- 페이로드로 작업 유형 및 매개변수 전달

**상태**: 승인됨

---

## ADR-006: S3 Presigned URL 방식

**결정**: 파일 업로드/다운로드에 S3 Presigned URL 사용

**배경**:
- Lambda 메모리 및 실행 시간 제한 회피
- 클라이언트 직접 업로드로 성능 향상
- 세밀한 권한 제어 가능
- 비용 효율적인 파일 처리

**대안 고려**:
- Lambda 프록시: 파일 크기 제한 및 성능 문제
- API Gateway 바이너리: 복잡한 설정 및 제한사항
- CloudFront 서명 URL: 업로드에는 부적합

**결과**:
- 5분 만료 시간으로 보안 강화
- 파일 타입 및 크기 사전 검증
- 업로드 완료 후 콜백으로 메타데이터 저장

**상태**: 승인됨

---

## ADR-007: 3명 미만 그룹 제외 규칙

**결정**: B2B 통계에서 3명 미만 그룹 데이터 제공 금지

**배경**:
- 개인정보 보호법 준수
- 개인 식별 가능성 최소화
- 통계적 유의성 확보
- 기업 고객 신뢰도 향상

**대안 고려**:
- 5명 미만: 과도하게 보수적, 유용한 통계 제한
- 2명 미만: 개인정보 보호 수준 부족
- 동적 임계값: 복잡성 증가, 일관성 부족

**결과**:
- 집계 단계에서 `participant_count >= 3` 필터 적용
- 조회 단계에서 추가 방어 검증
- 부족한 데이터는 "데이터 부족" 메시지로 대체

**상태**: 승인됨

---

## ADR-008: 의료 진단 면책 원칙

**결정**: 모든 엔진 응답에 "의료 진단이 아님" 면책 메시지 포함

**배경**:
- 의료기기법 및 관련 규정 준수
- 법적 책임 최소화
- 사용자 오해 방지
- 건강 관련 앱의 표준 관행

**대안 고려**:
- 면책 없음: 법적 위험 증가
- 별도 동의서: 사용자 경험 저하
- 앱 내 일반 고지: 가시성 부족

**결과**:
- HTTP 헤더 `X-Disclaimer`로 면책 메시지 제공
- 대시보드 API에서 `disclaimer` 필드 추가
- 엔진 응답 스키마는 변경하지 않음

**상태**: 승인됨

---

## ADR-009: 활성 사용자 정의 도입

**결정**: 배치 작업에서 "활성 사용자" 개념 도입 (7일 이내 접속)

**배경**:
- 불필요한 계산 리소스 절약
- 배치 작업 실행 시간 단축
- 비활성 사용자 캐시 공간 절약
- 시스템 확장성 향상

**대안 고려**:
- 모든 사용자: 리소스 낭비, 성능 저하
- 30일 기준: 너무 보수적, 복귀 사용자 고려 부족
- 1일 기준: 너무 짧음, 주말 사용자 제외

**결과**:
- `users` 테이블에 `last_active_at` 컬럼 추가
- API 호출 시마다 `last_active_at` 업데이트
- 배치 작업에서 활성 사용자만 처리

**상태**: 승인됨

---

## ADR-010: AWS 리전 선택 (us-east-1)

**결정**: 모든 AWS 리소스를 us-east-1 (버지니아 북부) 리전에 배포

**배경**:
- AWS 서비스 최신 기능 우선 제공 리전
- 글로벌 서비스 (CloudFront, Route53) 통합 최적화
- 비용 효율성 (가장 저렴한 리전 중 하나)
- 한국 사용자 대상이지만 CloudFront로 지연시간 해결

**대안 고려**:
- ap-northeast-2 (서울): 지연시간 최소화하지만 일부 서비스 제한
- ap-northeast-1 (도쿄): 서울 리전 대안이지만 비용 높음
- us-west-2 (오레곤): 비용 효율적이지만 지연시간 증가

**결과**:
- 모든 Lambda, RDS, ElastiCache를 us-east-1에 배포
- CloudFront로 한국 사용자 지연시간 최적화
- 비용 효율성과 서비스 가용성 확보

**상태**: 승인됨

---

## ADR-011: 하이브리드 아키텍처 선택

**결정**: Lambda + EC2 FastAPI 하이브리드 아키텍처 사용

**배경**:
- 단순 CRUD: Lambda 서버리스로 비용 효율성
- 복잡한 AI 계산: EC2 FastAPI로 성능 최적화
- Bedrock 통합: EC2에서 안정적인 AI 서비스 연동
- 확장성과 비용의 균형

**대안 고려**:
- 완전 서버리스: 복잡한 AI 계산에 Lambda 제한
- 완전 EC2: 단순 API에 과도한 리소스 사용
- ECS/Fargate: 관리 복잡도 증가

**결과**:
- Lambda: 사용자 관리, 근무표, 파일 처리
- EC2 FastAPI: 3대 엔진, AI 상담봇, Bedrock 연동
- API Gateway로 통합 라우팅

**상태**: 승인됨

---

## ADR-012: ElastiCache Serverless 선택

**결정**: 캐시 레이어로 ElastiCache Serverless 사용

**배경**:
- 서버리스 아키텍처와 일관성
- 자동 스케일링으로 운영 부담 최소화
- 비용 효율성 (사용량 기반 과금)
- RDS 부하 분산 및 성능 향상

**대안 고려**:
- ElastiCache 클러스터: 고정 비용 및 관리 복잡도
- RDS 캐시만 사용: 성능 제한
- DynamoDB: 캐시 용도에 부적합

**결과**:
- 엔진 계산 결과 캐시
- 세션 데이터 저장
- 자주 조회되는 사용자 프로필 캐시

**상태**: 승인됨